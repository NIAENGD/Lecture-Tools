<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lecture Tools</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --background: #f5f6f8;
        --text: #1f2933;
        --muted: #475569;
        --panel-bg: #ffffff;
        --panel-border: #d2d6dc;
        --panel-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
        --accent: #2563eb;
        --accent-contrast: #ffffff;
        --accent-muted: #e2e8f0;
        --danger: #dc2626;
        --danger-contrast: #ffffff;
        --placeholder: #64748b;
        --status-info-bg: #e0f2fe;
        --status-info-text: #0369a1;
        --status-error-bg: #fee2e2;
        --status-error-text: #b91c1c;
        --status-success-bg: #dcfce7;
        --status-success-text: #166534;
      }

      body[data-theme='light'] {
        color-scheme: light;
      }

      body[data-theme='dark'] {
        color-scheme: dark;
        --background: #0f172a;
        --text: #f8fafc;
        --muted: #94a3b8;
        --panel-bg: #1e293b;
        --panel-border: #334155;
        --panel-shadow: 0 1px 2px rgba(2, 6, 23, 0.5);
        --accent: #38bdf8;
        --accent-contrast: #0f172a;
        --accent-muted: rgba(56, 189, 248, 0.18);
        --danger: #f87171;
        --danger-contrast: #0f172a;
        --placeholder: #94a3b8;
        --status-info-bg: rgba(14, 165, 233, 0.2);
        --status-info-text: #bae6fd;
        --status-error-bg: rgba(248, 113, 113, 0.24);
        --status-error-text: #fecaca;
        --status-success-bg: rgba(74, 222, 128, 0.22);
        --status-success-text: #bbf7d0;
      }

      body[data-theme='system'] {
        color-scheme: light;
      }

      @media (prefers-color-scheme: dark) {
        body[data-theme='system'] {
          color-scheme: dark;
          --background: #0f172a;
          --text: #f8fafc;
          --muted: #94a3b8;
          --panel-bg: #1e293b;
          --panel-border: #334155;
          --panel-shadow: 0 1px 2px rgba(2, 6, 23, 0.5);
          --accent: #38bdf8;
          --accent-contrast: #0f172a;
          --accent-muted: rgba(56, 189, 248, 0.18);
          --danger: #f87171;
          --danger-contrast: #0f172a;
          --placeholder: #94a3b8;
          --status-info-bg: rgba(14, 165, 233, 0.2);
          --status-info-text: #bae6fd;
          --status-error-bg: rgba(248, 113, 113, 0.24);
          --status-error-text: #fecaca;
          --status-success-bg: rgba(74, 222, 128, 0.22);
          --status-success-text: #bbf7d0;
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        font-size: 15px;
        background: var(--background);
        color: var(--text);
        transition: background 0.2s ease, color 0.2s ease;
      }

      main.layout {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
        display: flex;
        gap: 24px;
        align-items: flex-start;
      }

      .sidebar {
        width: 320px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .panel {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        padding: 18px 20px;
        box-shadow: var(--panel-shadow);
        transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      }

      .panel-heading {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
        color: var(--muted);
      }

      .panel-heading label {
        margin: 0;
        color: inherit;
      }

      .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 20px 0;
        border-bottom: 1px solid var(--panel-border);
        background: var(--panel-bg);
        border-radius: 8px 8px 0 0;
      }

      .top-bar-left,
      .top-bar-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .top-bar button {
        border-radius: 999px;
        border: 1px solid transparent;
        background: var(--accent-muted);
        color: var(--text);
        padding: 6px 14px;
        font-weight: 600;
        transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      }

      .top-bar button[data-view]:hover {
        background: var(--accent);
        color: var(--accent-contrast);
        border-color: var(--accent);
      }

      .top-bar button.active {
        background: var(--accent);
        border-color: var(--accent);
        color: var(--accent-contrast);
      }

      .top-bar button.ghost {
        background: transparent;
        border-color: var(--panel-border);
        color: var(--muted);
      }

      .top-bar button.ghost:hover {
        border-color: var(--accent);
        color: var(--text);
      }

      .top-bar button.ghost.active {
        background: var(--accent);
        border-color: var(--accent);
        color: var(--accent-contrast);
      }

      .content-panel {
        padding: 0;
        overflow: hidden;
      }

      .content-panel .view {
        padding: 20px;
      }

      .view {
        display: none;
      }

      .view.active {
        display: block;
      }

      .edit-banner {
        background: var(--status-info-bg);
        color: var(--status-info-text);
        border: 1px solid var(--panel-border);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.9rem;
        margin-bottom: 12px;
      }

      h1 {
        font-size: 1.6rem;
        margin: 0 0 8px;
      }

      h2 {
        font-size: 1.2rem;
        margin: 0 0 12px;
      }

      h3 {
        font-size: 1rem;
        margin: 16px 0 8px;
      }

      p {
        margin: 0 0 12px;
        line-height: 1.5;
      }

      label {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
        font-size: 0.9rem;
        color: var(--muted);
      }

      input[type='text'],
      input[type='search'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid var(--panel-border);
        font-family: inherit;
        font-size: 0.95rem;
        background: var(--panel-bg);
        color: var(--text);
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      textarea {
        resize: vertical;
        min-height: 96px;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
      }

      button {
        border: 1px solid var(--accent);
        background: var(--accent);
        color: var(--accent-contrast);
        border-radius: 6px;
        padding: 8px 14px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      }

      button:hover {
        opacity: 0.92;
      }

      button.secondary {
        background: transparent;
        color: var(--accent);
      }

      button.secondary:hover {
        background: rgba(37, 99, 235, 0.12);
      }

      button.danger {
        background: var(--danger);
        border-color: var(--danger);
        color: var(--danger-contrast);
      }

      button.danger:hover {
        opacity: 0.9;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .pill {
        border-radius: 999px;
      }

      .status-bar {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        max-width: 1200px;
        margin: 0 auto;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 0.9rem;
        display: none;
      }

      .status-bar[data-variant='error'] {
        background: var(--status-error-bg);
        color: var(--status-error-text);
        border-color: var(--status-error-bg);
      }

      .status-bar[data-variant='success'] {
        background: var(--status-success-bg);
        color: var(--status-success-text);
        border-color: var(--status-success-bg);
      }

      .status-bar[data-variant='info'] {
        background: var(--status-info-bg);
        color: var(--status-info-text);
        border-color: var(--status-info-bg);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
      }

      .stats-grid div {
        border: 1px solid var(--panel-border);
        border-radius: 6px;
        padding: 10px;
        background: var(--background);
      }

      .stats-grid dt {
        margin: 0;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--muted);
      }

      .stats-grid dd {
        margin: 4px 0 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text);
      }

      .curriculum {
        margin-top: 12px;
        border: 1px solid var(--panel-border);
        border-radius: 6px;
        padding: 8px;
        background: var(--panel-bg);
        max-height: calc(100vh - 260px);
        overflow-y: auto;
        font-size: 0.95rem;
      }

      .curriculum ul {
        list-style: none;
        margin: 0;
        padding-left: 12px;
      }

      .curriculum li {
        margin-bottom: 6px;
      }

      .curriculum-toolbar {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-bottom: 8px;
      }

      .class-item,
      .module-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .class-item {
        font-weight: 600;
        margin-top: 8px;
      }

      .module-item {
        margin-left: 6px;
        font-weight: 500;
      }

      .lecture-row {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
      }

      .lecture-button {
        flex: 1;
        text-align: left;
        padding: 6px 8px;
        border: 1px solid transparent;
        border-radius: 4px;
        background: transparent;
        cursor: pointer;
        font-size: 0.95rem;
        color: inherit;
        transition: border-color 0.2s ease, background 0.2s ease;
      }

      .lecture-button:hover,
      .lecture-button:focus {
        border-color: var(--panel-border);
        background: var(--accent-muted);
        outline: none;
      }

      .lecture-button.active {
        border-color: var(--accent);
        background: rgba(37, 99, 235, 0.12);
      }

      .item-actions {
        display: flex;
        gap: 6px;
        margin-left: auto;
      }

      button.text-button {
        background: transparent;
        border: none;
        color: var(--accent);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }

      button.text-button:hover {
        background: var(--accent-muted);
      }

      button.text-button.danger {
        color: var(--danger);
      }

      button.text-button.danger:hover {
        background: rgba(220, 38, 38, 0.12);
      }

      .placeholder {
        color: var(--placeholder);
        font-style: italic;
      }

      .field {
        margin-bottom: 12px;
      }

      .form-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }

      .asset-list {
        list-style: none;
        margin: 12px 0 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .asset-item {
        border: 1px solid var(--panel-border);
        border-radius: 6px;
        padding: 10px 12px;
        background: var(--background);
      }

      .asset-header {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .asset-status {
        font-size: 0.9rem;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .asset-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .asset-actions a {
        color: var(--accent);
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .asset-actions a[aria-disabled='true'] {
        pointer-events: none;
        color: var(--muted);
      }

      .file-input {
        position: relative;
        overflow: hidden;
        display: inline-flex;
        align-items: center;
        border-radius: 6px;
        border: 1px dashed var(--panel-border);
        padding: 0;
        cursor: pointer;
        color: var(--accent);
        background: transparent;
      }

      .file-input span {
        display: inline-block;
        padding: 6px 10px;
        font-size: 0.9rem;
        font-weight: 600;
      }

      .file-input:hover {
        border-color: var(--accent);
      }

      .file-input input[type='file'] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      .actions-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: flex-end;
        margin-top: 12px;
      }

      .actions-row label.inline {
        display: inline-flex;
        flex-direction: column;
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .actions-row label.inline select,
      .actions-row label.inline input {
        margin-top: 4px;
        min-width: 120px;
      }

      #asset-section {
        margin-top: 16px;
      }

      #settings-form fieldset {
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        padding: 16px;
        margin: 0 0 16px;
      }

      #settings-form fieldset:last-of-type {
        margin-bottom: 0;
      }

      #settings-form legend {
        font-weight: 600;
        color: var(--muted);
        padding: 0 6px;
      }

      #settings-form .field-inline {
        display: flex;
        flex-direction: column;
        margin-bottom: 12px;
      }

      #settings-form .field-inline:last-child {
        margin-bottom: 0;
      }

      @media (max-width: 960px) {
        main.layout {
          flex-direction: column;
          padding: 16px;
        }

        .sidebar {
          width: auto;
        }

        .curriculum {
          max-height: 320px;
        }
      }
    </style>
  </head>
  <body>
    <div id="status-bar" class="status-bar" role="status"></div>
    <main class="layout">
      <aside class="sidebar">
        <section class="panel">
          <h1>Lecture Tools</h1>
          <p>Review, organise, and process lecture resources quickly.</p>
        </section>
        <section class="panel">
          <h2>Overview</h2>
          <dl id="stats" class="stats-grid"></dl>
        </section>
        <section class="panel">
          <div class="panel-heading">
            <label for="search-input">Filter curriculum</label>
          </div>
          <input
            id="search-input"
            type="search"
            placeholder="Search by name"
            autocomplete="off"
          />
          <div id="curriculum" class="curriculum placeholder">Loading…</div>
        </section>
      </aside>
      <section class="content">
        <section class="panel content-panel">
          <div class="top-bar" role="tablist">
            <div class="top-bar-left">
              <button type="button" class="active" data-view="details" aria-pressed="true">
                Details
              </button>
              <button
                id="toggle-edit-mode"
                type="button"
                class="ghost pill"
                aria-pressed="false"
              >
                Enable edit mode
              </button>
            </div>
            <div class="top-bar-right">
              <button type="button" data-view="create" aria-pressed="false">Create</button>
              <button type="button" data-view="settings" aria-pressed="false">Settings</button>
            </div>
          </div>
          <div id="view-details" class="view active" data-view="details">
            <header style="display: flex; justify-content: space-between; align-items: center;">
              <h2>Lecture details</h2>
              <button id="delete-lecture" class="danger" type="button" hidden>
                Delete lecture
              </button>
            </header>
            <div id="edit-mode-banner" class="edit-banner" hidden>
              Edit mode is enabled. Update lecture information or remove items while it is active.
            </div>
            <div id="lecture-summary" class="placeholder">
              Select a lecture from the curriculum.
            </div>
            <form id="lecture-edit-form" hidden>
              <div class="field">
                <label for="edit-lecture-name">Title</label>
                <input id="edit-lecture-name" name="name" type="text" required />
              </div>
              <div class="field">
                <label for="edit-lecture-module">Module</label>
                <select id="edit-lecture-module" name="module" required></select>
              </div>
              <div class="field">
                <label for="edit-lecture-description">Description</label>
                <textarea
                  id="edit-lecture-description"
                  name="description"
                  rows="4"
                ></textarea>
              </div>
              <div class="form-actions">
                <button type="submit">Save changes</button>
              </div>
            </form>
            <section id="asset-section" hidden>
              <h3>Assets</h3>
              <ul id="asset-list" class="asset-list"></ul>
              <div class="actions-row">
                <button id="transcribe-button" type="button">Transcribe audio</button>
                <label class="inline" for="transcribe-model" style="margin-left: auto;">
                  Model
                  <select id="transcribe-model">
                    <option value="tiny">tiny</option>
                    <option value="base" selected>base</option>
                    <option value="small">small</option>
                    <option value="medium">medium</option>
                    <option value="large">large</option>
                  </select>
                </label>
              </div>
            </section>
          </div>
          <div id="view-create" class="view" data-view="create" hidden>
            <h2>Create lecture</h2>
            <form id="lecture-create-form">
              <div class="field">
                <label for="create-module">Module</label>
                <select id="create-module" required></select>
              </div>
              <div class="field">
                <label for="create-name">Title</label>
                <input id="create-name" type="text" required />
              </div>
              <div class="field">
                <label for="create-description">Description</label>
                <textarea id="create-description" rows="4"></textarea>
              </div>
              <div class="form-actions">
                <button id="create-submit" type="submit">Add lecture</button>
              </div>
            </form>
          </div>
          <div id="view-settings" class="view" data-view="settings" hidden>
            <h2>Settings</h2>
            <form id="settings-form">
              <fieldset>
                <legend>Appearance</legend>
                <div class="field-inline">
                  <label for="settings-theme">Theme</label>
                  <select id="settings-theme">
                    <option value="system">Follow system</option>
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                  </select>
                </div>
              </fieldset>
              <fieldset>
                <legend>Whisper transcription</legend>
                <div class="field-inline">
                  <label for="settings-whisper-model">Default model</label>
                  <input id="settings-whisper-model" type="text" required />
                </div>
                <div class="field-inline">
                  <label for="settings-whisper-compute">Compute type</label>
                  <input id="settings-whisper-compute" type="text" required />
                </div>
                <div class="field-inline">
                  <label for="settings-whisper-beam">Beam size</label>
                  <input id="settings-whisper-beam" type="number" min="1" max="10" required />
                </div>
              </fieldset>
              <fieldset>
                <legend>Slides</legend>
                <div class="field-inline">
                  <label for="settings-slide-dpi">Rendering DPI</label>
                  <input id="settings-slide-dpi" type="number" min="72" max="600" step="10" required />
                </div>
              </fieldset>
              <div class="form-actions">
                <button type="submit">Save settings</button>
              </div>
            </form>
          </div>
        </section>
      </section>
    </main>
    <script>
      (function () {
        const state = {
          classes: [],
          stats: {},
          query: '',
          selectedLectureId: null,
          buttonMap: new Map(),
          editMode: false,
          activeView: 'details',
          settings: null,
        };

        const dom = {
          status: document.getElementById('status-bar'),
          stats: document.getElementById('stats'),
          curriculum: document.getElementById('curriculum'),
          search: document.getElementById('search-input'),
          summary: document.getElementById('lecture-summary'),
          editForm: document.getElementById('lecture-edit-form'),
          editName: document.getElementById('edit-lecture-name'),
          editModule: document.getElementById('edit-lecture-module'),
          editDescription: document.getElementById('edit-lecture-description'),
          deleteButton: document.getElementById('delete-lecture'),
          editToggle: document.getElementById('toggle-edit-mode'),
          editBanner: document.getElementById('edit-mode-banner'),
          assetSection: document.getElementById('asset-section'),
          assetList: document.getElementById('asset-list'),
          transcribeButton: document.getElementById('transcribe-button'),
          transcribeModel: document.getElementById('transcribe-model'),
          createForm: document.getElementById('lecture-create-form'),
          createModule: document.getElementById('create-module'),
          createName: document.getElementById('create-name'),
          createDescription: document.getElementById('create-description'),
          createSubmit: document.getElementById('create-submit'),
          viewButtons: Array.from(document.querySelectorAll('.top-bar [data-view]')),
          views: {
            details: document.getElementById('view-details'),
            create: document.getElementById('view-create'),
            settings: document.getElementById('view-settings'),
          },
          settingsForm: document.getElementById('settings-form'),
          settingsTheme: document.getElementById('settings-theme'),
          settingsWhisperModel: document.getElementById('settings-whisper-model'),
          settingsWhisperCompute: document.getElementById('settings-whisper-compute'),
          settingsWhisperBeam: document.getElementById('settings-whisper-beam'),
          settingsSlideDpi: document.getElementById('settings-slide-dpi'),
        };

        const assetDefinitions = [
          {
            key: 'audio_path',
            label: 'Audio',
            accept: 'audio/*,video/*',
            type: 'audio',
          },
          {
            key: 'slide_path',
            label: 'Slides (PDF)',
            accept: 'application/pdf',
            type: 'slides',
          },
          {
            key: 'transcript_path',
            label: 'Transcript',
            accept: '.txt,.md,text/plain',
            type: 'transcript',
          },
          {
            key: 'notes_path',
            label: 'Notes',
            accept:
              '.txt,.md,.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            type: 'notes',
          },
          {
            key: 'slide_image_dir',
            label: 'Slide images (ZIP)',
            accept: null,
            type: 'slide_images',
            reveal: 'folder',
          },
        ];

        function showStatus(message, variant = 'info') {
          if (!message) {
            dom.status.style.display = 'none';
            dom.status.textContent = '';
            dom.status.removeAttribute('data-variant');
            return;
          }
          dom.status.textContent = message;
          dom.status.dataset.variant = variant;
          dom.status.style.display = 'block';
        }

        function formatNumber(value) {
          return new Intl.NumberFormat().format(value ?? 0);
        }

        function formatBytes(bytes) {
          if (typeof bytes !== 'number' || Number.isNaN(bytes)) {
            return '';
          }
          if (bytes < 1024) {
            return `${bytes} B`;
          }
          const units = ['KB', 'MB', 'GB', 'TB'];
          let value = bytes / 1024;
          let unitIndex = 0;
          while (value >= 1024 && unitIndex < units.length - 1) {
            value /= 1024;
            unitIndex += 1;
          }
          return `${value >= 100 ? Math.round(value) : value.toFixed(1)} ${units[unitIndex]}`;
        }

        function formatDate(isoString) {
          if (!isoString) {
            return '';
          }
          const formatter = new Intl.DateTimeFormat(undefined, {
            dateStyle: 'medium',
            timeStyle: 'short',
          });
          return formatter.format(new Date(isoString));
        }

        function buildStorageURL(path) {
          if (!path) {
            return '#';
          }
          return `/storage/${path
            .split('/')
            .map((segment) => encodeURIComponent(segment))
            .join('/')}`;
        }

        async function request(url, options = {}) {
          const response = await fetch(url, options);
          if (!response.ok) {
            let detail = `${response.status} ${response.statusText}`;
            try {
              const payload = await response.json();
              if (payload && payload.detail) {
                detail = payload.detail;
              }
            } catch (error) {
              // Ignore JSON parsing errors.
            }
            throw new Error(detail);
          }
          if (response.status === 204) {
            return null;
          }
          const contentType = response.headers.get('content-type') || '';
          if (contentType.includes('application/json')) {
            return await response.json();
          }
          return null;
        }

        function clearDetailPanel() {
          dom.summary.textContent = 'Select a lecture from the curriculum.';
          dom.summary.classList.add('placeholder');
          if (dom.editForm) {
            dom.editForm.reset();
          }
          dom.assetSection.hidden = true;
          dom.assetList.innerHTML = '';
          dom.transcribeButton.disabled = true;
          updateEditControlsAvailability();
        }

        function updateEditControlsAvailability() {
          const hasSelection = Boolean(state.selectedLectureId);
          const allowEditing = state.editMode && hasSelection;
          dom.editForm.hidden = !allowEditing;
          dom.deleteButton.hidden = !allowEditing;
        }

        function updateEditModeUI() {
          const isActive = state.editMode;
          if (dom.editToggle) {
            dom.editToggle.textContent = isActive ? 'Exit edit mode' : 'Enable edit mode';
            dom.editToggle.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            dom.editToggle.classList.toggle('active', isActive);
          }
          if (dom.editBanner) {
            dom.editBanner.hidden = !isActive;
          }
          renderCurriculum();
          updateEditControlsAvailability();
        }

        function setActiveView(view) {
          if (!dom.views[view]) {
            return;
          }
          state.activeView = view;
          dom.viewButtons.forEach((button) => {
            const isActive = button.dataset.view === view;
            button.classList.toggle('active', isActive);
            button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
          });
          Object.entries(dom.views).forEach(([key, element]) => {
            if (!element) {
              return;
            }
            const isActive = key === view;
            element.classList.toggle('active', isActive);
            element.hidden = !isActive;
          });
        }

        function updateStats() {
          const stats = state.stats;
          const entries = [
            ['Classes', stats.class_count],
            ['Modules', stats.module_count],
            ['Lectures', stats.lecture_count],
            ['Transcripts', stats.transcript_count],
            ['Slide decks', stats.slide_count],
            ['Audio files', stats.audio_count],
            ['Notes', stats.notes_count],
            ['Slide archives', stats.slide_image_count],
          ];
          dom.stats.innerHTML = '';
          entries.forEach(([label, value]) => {
            const block = document.createElement('div');
            const term = document.createElement('dt');
            term.textContent = label;
            const data = document.createElement('dd');
            data.textContent = formatNumber(value);
            block.appendChild(term);
            block.appendChild(data);
            dom.stats.appendChild(block);
          });
        }

        function updateModuleOptions() {
          const modules = [];
          state.classes.forEach((klass) => {
            (klass.modules || []).forEach((module) => {
              modules.push({
                id: module.id,
                label: `${klass.name} • ${module.name}`,
              });
            });
          });
          modules.sort((a, b) => a.label.localeCompare(b.label));

          dom.createModule.innerHTML = '';
          dom.editModule.innerHTML = '';

          const createPlaceholder = document.createElement('option');
          createPlaceholder.value = '';
          createPlaceholder.textContent = modules.length
            ? 'Select module…'
            : 'No modules available';
          createPlaceholder.disabled = modules.length === 0;
          createPlaceholder.selected = true;
          dom.createModule.appendChild(createPlaceholder);

          modules.forEach((module) => {
            const option = document.createElement('option');
            option.value = String(module.id);
            option.textContent = module.label;
            dom.createModule.appendChild(option.cloneNode(true));
            dom.editModule.appendChild(option);
          });

          dom.createModule.disabled = modules.length === 0;
          dom.createSubmit.disabled = modules.length === 0;
        }

        function matchQuery(text, query) {
          return typeof text === 'string' && text.toLowerCase().includes(query);
        }

        function computeFilteredClasses() {
          const query = state.query.trim().toLowerCase();
          if (!query) {
            return state.classes.map((klass) => ({
              class: klass,
              modules: (klass.modules || []).map((module) => ({
                module,
                lectures: module.lectures || [],
              })),
            }));
          }

          const filtered = [];
          state.classes.forEach((klass) => {
            const classMatch = matchQuery(klass.name, query) || matchQuery(klass.description, query);
            const modules = [];
            (klass.modules || []).forEach((module) => {
              const moduleMatch =
                classMatch || matchQuery(module.name, query) || matchQuery(module.description, query);
              let lectures = module.lectures || [];
              if (!moduleMatch) {
                lectures = (module.lectures || []).filter(
                  (lecture) =>
                    matchQuery(lecture.name, query) || matchQuery(lecture.description, query),
                );
              }
              if (moduleMatch && lectures.length === 0) {
                lectures = module.lectures || [];
              }
              if (lectures.length > 0) {
                modules.push({ module, lectures });
              }
            });
            if (modules.length > 0) {
              filtered.push({ class: klass, modules });
            }
          });
          return filtered;
        }

        function highlightSelected() {
          state.buttonMap.forEach((button, lectureId) => {
            if (lectureId === state.selectedLectureId) {
              button.classList.add('active');
              button.setAttribute('aria-current', 'true');
            } else {
              button.classList.remove('active');
              button.removeAttribute('aria-current');
            }
          });
        }

        function renderCurriculum() {
          state.buttonMap.clear();
          const filtered = computeFilteredClasses();
          dom.curriculum.innerHTML = '';
          dom.curriculum.classList.remove('placeholder');

          if (state.editMode) {
            const toolbar = document.createElement('div');
            toolbar.className = 'curriculum-toolbar';
            const addClassButton = document.createElement('button');
            addClassButton.type = 'button';
            addClassButton.className = 'secondary pill';
            addClassButton.textContent = 'Add class';
            addClassButton.addEventListener('click', handleAddClass);
            toolbar.appendChild(addClassButton);
            dom.curriculum.appendChild(toolbar);
          }

          if (filtered.length === 0) {
            const message = document.createElement('div');
            message.className = 'placeholder';
            message.textContent = state.classes.length
              ? 'No lectures match the current filter.'
              : 'No classes available yet.';
            dom.curriculum.appendChild(message);
            dom.curriculum.classList.add('placeholder');
            return;
          }

          const list = document.createElement('ul');
          filtered.forEach((entry) => {
            const classItem = document.createElement('li');
            const classTitle = document.createElement('div');
            classTitle.className = 'class-item';
            const className = document.createElement('span');
            className.textContent = entry.class.name;
            classTitle.appendChild(className);

            if (state.editMode) {
              const classActions = document.createElement('div');
              classActions.className = 'item-actions';

              const addModuleButton = document.createElement('button');
              addModuleButton.type = 'button';
              addModuleButton.className = 'text-button';
              addModuleButton.textContent = 'Add module';
              addModuleButton.addEventListener('click', (event) => {
                event.stopPropagation();
                handleAddModule(entry.class);
              });
              classActions.appendChild(addModuleButton);

              const deleteClassButton = document.createElement('button');
              deleteClassButton.type = 'button';
              deleteClassButton.className = 'text-button danger';
              deleteClassButton.textContent = 'Delete';
              deleteClassButton.addEventListener('click', (event) => {
                event.stopPropagation();
                handleDeleteClass(entry);
              });
              classActions.appendChild(deleteClassButton);

              classTitle.appendChild(classActions);
            }

            classItem.appendChild(classTitle);

            const moduleList = document.createElement('ul');
            entry.modules.forEach((moduleEntry) => {
              const moduleItem = document.createElement('li');
              const moduleTitle = document.createElement('div');
              moduleTitle.className = 'module-item';
              const moduleName = document.createElement('span');
              moduleName.textContent = moduleEntry.module.name;
              moduleTitle.appendChild(moduleName);

              if (state.editMode) {
                const moduleActions = document.createElement('div');
                moduleActions.className = 'item-actions';

                const addLectureButton = document.createElement('button');
                addLectureButton.type = 'button';
                addLectureButton.className = 'text-button';
                addLectureButton.textContent = 'Add lecture';
                addLectureButton.addEventListener('click', (event) => {
                  event.stopPropagation();
                  handleAddLecture(moduleEntry.module, entry.class);
                });
                moduleActions.appendChild(addLectureButton);

                const deleteModuleButton = document.createElement('button');
                deleteModuleButton.type = 'button';
                deleteModuleButton.className = 'text-button danger';
                deleteModuleButton.textContent = 'Delete';
                deleteModuleButton.addEventListener('click', (event) => {
                  event.stopPropagation();
                  handleDeleteModule(moduleEntry, entry.class);
                });
                moduleActions.appendChild(deleteModuleButton);

                moduleTitle.appendChild(moduleActions);
              }

              moduleItem.appendChild(moduleTitle);

              const lectureList = document.createElement('ul');
              moduleEntry.lectures.forEach((lecture) => {
                const lectureItem = document.createElement('li');
                const lectureRow = document.createElement('div');
                lectureRow.className = 'lecture-row';

                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'lecture-button';
                button.textContent = lecture.name;
                button.addEventListener('click', () => selectLecture(lecture.id));
                lectureRow.appendChild(button);
                state.buttonMap.set(lecture.id, button);

                if (state.editMode) {
                  const lectureActions = document.createElement('div');
                  lectureActions.className = 'item-actions';

                  const deleteLectureButton = document.createElement('button');
                  deleteLectureButton.type = 'button';
                  deleteLectureButton.className = 'text-button danger';
                  deleteLectureButton.textContent = 'Delete';
                  deleteLectureButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    handleDeleteLecture(lecture, moduleEntry.module, entry.class);
                  });
                  lectureActions.appendChild(deleteLectureButton);

                  lectureRow.appendChild(lectureActions);
                }

                lectureItem.appendChild(lectureRow);
                lectureList.appendChild(lectureItem);
              });

              if (moduleEntry.lectures.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'placeholder';
                empty.textContent = 'No lectures';
                lectureList.appendChild(empty);
              }

              moduleItem.appendChild(lectureList);
              moduleList.appendChild(moduleItem);
            });

            classItem.appendChild(moduleList);
            list.appendChild(classItem);
          });

          dom.curriculum.appendChild(list);
          highlightSelected();
        }

        function requireEditMode(message = 'Enable edit mode to manage the curriculum.') {
          if (!state.editMode) {
            showStatus(message, 'info');
            return false;
          }
          return true;
        }

        async function handleAddClass() {
          if (!requireEditMode()) {
            return;
          }
          const name = window.prompt('Class name');
          if (!name || !name.trim()) {
            return;
          }
          const description = window.prompt('Description (optional)') ?? '';
          try {
            await request('/api/classes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: name.trim(), description: description.trim() }),
            });
            showStatus('Class created.', 'success');
            await refreshData();
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        async function handleAddModule(classRecord) {
          if (!requireEditMode()) {
            return;
          }
          const name = window.prompt(`Module name for ${classRecord.name}`);
          if (!name || !name.trim()) {
            return;
          }
          const description = window.prompt('Description (optional)') ?? '';
          try {
            await request('/api/modules', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                class_id: classRecord.id,
                name: name.trim(),
                description: description.trim(),
              }),
            });
            showStatus('Module created.', 'success');
            await refreshData();
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        async function handleDeleteClass(classEntry) {
          if (!requireEditMode()) {
            return;
          }
          const moduleCount = classEntry.modules.length;
          const lectureCount = classEntry.modules.reduce(
            (total, moduleEntry) => total + (moduleEntry.lectures?.length || 0),
            0,
          );
          let message = `Delete class "${classEntry.class.name}"?`;
          if (moduleCount || lectureCount) {
            message += `\n\nThis will remove ${moduleCount} module${moduleCount === 1 ? '' : 's'} and ${lectureCount} lecture${lectureCount === 1 ? '' : 's'}.`;
          }
          const confirmed = window.confirm(message);
          if (!confirmed) {
            return;
          }
          try {
            await request(`/api/classes/${classEntry.class.id}`, { method: 'DELETE' });
            if (state.selectedLectureId) {
              const removed = classEntry.modules.some((moduleEntry) =>
                (moduleEntry.lectures || []).some(
                  (lecture) => lecture.id === state.selectedLectureId,
                ),
              );
              if (removed) {
                state.selectedLectureId = null;
                clearDetailPanel();
              }
            }
            showStatus('Class removed.', 'success');
            await refreshData();
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        async function handleDeleteModule(moduleEntry, classRecord) {
          if (!requireEditMode()) {
            return;
          }
          const lectureCount = moduleEntry.lectures.length;
          let message = `Delete module "${moduleEntry.module.name}"`;
          if (classRecord) {
            message += ` from "${classRecord.name}"`;
          }
          message += '?';
          if (lectureCount) {
            message += `\n\nThis will remove ${lectureCount} lecture${lectureCount === 1 ? '' : 's'}.`;
          }
          const confirmed = window.confirm(message);
          if (!confirmed) {
            return;
          }
          try {
            await request(`/api/modules/${moduleEntry.module.id}`, { method: 'DELETE' });
            if (state.selectedLectureId) {
              const removed = (moduleEntry.lectures || []).some(
                (lecture) => lecture.id === state.selectedLectureId,
              );
              if (removed) {
                state.selectedLectureId = null;
                clearDetailPanel();
              }
            }
            showStatus('Module removed.', 'success');
            await refreshData();
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        async function handleAddLecture(moduleRecord, classRecord) {
          if (!requireEditMode()) {
            return;
          }
          const namePrompt = classRecord
            ? `Lecture title for ${classRecord.name} • ${moduleRecord.name}`
            : `Lecture title for ${moduleRecord.name}`;
          const name = window.prompt(namePrompt);
          if (!name || !name.trim()) {
            return;
          }
          const description = window.prompt('Description (optional)') ?? '';
          try {
            const payload = await request('/api/lectures', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                module_id: moduleRecord.id,
                name: name.trim(),
                description: description.trim(),
              }),
            });
            showStatus('Lecture created.', 'success');
            await refreshData();
            const newLectureId = payload?.lecture?.id;
            if (newLectureId) {
              await selectLecture(newLectureId);
            }
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        async function handleDeleteLecture(lecture, moduleRecord, classRecord) {
          if (!requireEditMode()) {
            return;
          }
          let context = lecture.name;
          if (moduleRecord) {
            context += ` in ${moduleRecord.name}`;
          }
          if (classRecord) {
            context += ` (${classRecord.name})`;
          }
          const confirmed = window.confirm(`Delete lecture "${context}"?`);
          if (!confirmed) {
            return;
          }
          try {
            await request(`/api/lectures/${lecture.id}`, { method: 'DELETE' });
            if (state.selectedLectureId === lecture.id) {
              state.selectedLectureId = null;
              clearDetailPanel();
            }
            showStatus('Lecture removed.', 'success');
            await refreshData();
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        function applyTheme(theme) {
          const target = theme || 'system';
          document.body.dataset.theme = target;
        }

        function ensureTranscribeOption(value) {
          if (!value) {
            return;
          }
          const exists = Array.from(dom.transcribeModel.options).some(
            (option) => option.value === value,
          );
          if (!exists) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            dom.transcribeModel.appendChild(option);
          }
        }

        async function loadSettings() {
          try {
            const payload = await request('/api/settings');
            const settings = payload?.settings;
            if (!settings) {
              return;
            }
            state.settings = settings;
            dom.settingsTheme.value = settings.theme ?? 'system';
            dom.settingsWhisperModel.value = settings.whisper_model ?? 'base';
            dom.settingsWhisperCompute.value = settings.whisper_compute_type ?? 'int8';
            dom.settingsWhisperBeam.value = String(settings.whisper_beam_size ?? 5);
            dom.settingsSlideDpi.value = String(settings.slide_dpi ?? 200);
            ensureTranscribeOption(settings.whisper_model);
            dom.transcribeModel.value = settings.whisper_model;
            applyTheme(settings.theme);
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        function renderAssets(lecture) {
          dom.assetList.innerHTML = '';
          assetDefinitions.forEach((definition) => {
            const value = lecture[definition.key];
            const item = document.createElement('li');
            item.className = 'asset-item';
            const header = document.createElement('div');
            header.className = 'asset-header';
            header.textContent = definition.label;
            item.appendChild(header);

            const status = document.createElement('div');
            status.className = 'asset-status';
            let statusText = 'Not linked';
            if (definition.type === 'slides') {
              statusText = value
                ? `Linked: ${value.split('/').pop()} (auto processed)`
                : 'Upload a PDF to generate slide images automatically.';
            } else if (definition.type === 'slide_images') {
              statusText = value
                ? `Archive created: ${value.split('/').pop()}`
                : 'No slide images generated yet.';
            } else if (value) {
              statusText = `Linked: ${value.split('/').pop()}`;
            }
            status.textContent = statusText;
            item.appendChild(status);

            const actions = document.createElement('div');
            actions.className = 'asset-actions';

            if (definition.accept) {
              const wrapper = document.createElement('label');
              wrapper.className = 'file-input';
              const span = document.createElement('span');
              span.textContent = 'Upload';
              const input = document.createElement('input');
              input.type = 'file';
              input.accept = definition.accept;
              input.addEventListener('change', (event) => {
                const target = event.target;
                const file = target.files && target.files[0];
                target.value = '';
                if (file) {
                  handleAssetUpload(definition.type, file);
                }
              });
              wrapper.appendChild(span);
              wrapper.appendChild(input);
              actions.appendChild(wrapper);
            }

            const link = document.createElement('a');
            link.textContent = 'Open';
            if (value) {
              link.href = buildStorageURL(value);
              link.target = '_blank';
              link.rel = 'noopener';
            } else {
              link.href = '#';
              link.setAttribute('aria-disabled', 'true');
            }
            actions.appendChild(link);

            if (definition.reveal) {
              const revealButton = document.createElement('button');
              revealButton.type = 'button';
              revealButton.className = 'secondary';
              revealButton.textContent =
                definition.reveal === 'folder' ? 'Reveal folder' : 'Reveal location';
              revealButton.disabled = !value;
              revealButton.addEventListener('click', () => {
                if (value) {
                  revealAsset(value, definition.reveal);
                }
              });
              actions.appendChild(revealButton);
            }

            item.appendChild(actions);
            dom.assetList.appendChild(item);
          });
        }

        function renderSummary(detail) {
          const lecture = detail.lecture;
          const module = detail.module;
          const classRecord = detail.class;

          dom.summary.classList.remove('placeholder');
          dom.summary.innerHTML = '';

          const title = document.createElement('h3');
          title.textContent = lecture.name;
          dom.summary.appendChild(title);

          const context = document.createElement('div');
          context.className = 'asset-status';
          context.textContent = `${classRecord.name} • ${module.name}`;
          dom.summary.appendChild(context);

          const description = document.createElement('p');
          description.textContent = lecture.description || 'No description recorded yet.';
          dom.summary.appendChild(description);
        }

        async function refreshData() {
          try {
            const payload = await request('/api/classes');
            state.classes = payload?.classes || [];
            state.stats = payload?.stats || {};
            updateStats();
            updateModuleOptions();
            renderCurriculum();

            if (state.selectedLectureId) {
              const exists = state.classes.some((klass) =>
                (klass.modules || []).some((module) =>
                  (module.lectures || []).some((lecture) => lecture.id === state.selectedLectureId),
                ),
              );
              if (!exists) {
                state.selectedLectureId = null;
                clearDetailPanel();
              }
            }
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        async function selectLecture(lectureId) {
          state.selectedLectureId = lectureId;
          highlightSelected();
          setActiveView('details');
          try {
            const detail = await request(`/api/lectures/${lectureId}`);
            if (!detail) {
              return;
            }
            renderSummary(detail);
            dom.assetSection.hidden = false;

            dom.editName.value = detail.lecture.name;
            dom.editDescription.value = detail.lecture.description || '';
            dom.editModule.value = String(detail.lecture.module_id);

            updateEditControlsAvailability();

            if (state.editMode) {
              dom.editName.focus();
            }

            dom.transcribeButton.disabled = !detail.lecture.audio_path;

            renderAssets(detail.lecture);
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        async function handleAssetUpload(kind, file) {
          if (!state.selectedLectureId) {
            return;
          }
          const formData = new FormData();
          formData.append('file', file);
          try {
            await request(`/api/lectures/${state.selectedLectureId}/assets/${kind}`, {
              method: 'POST',
              body: formData,
            });
            const successMessage =
              kind === 'slides'
                ? 'Slides uploaded and processed into an image archive.'
                : 'Asset uploaded successfully.';
            showStatus(successMessage, 'success');
            await refreshData();
            await selectLecture(state.selectedLectureId);
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        function buildRevealPayload(relativePath, mode = 'file') {
          if (!relativePath) {
            return null;
          }
          if (mode === 'folder') {
            const segments = relativePath.split('/').filter(Boolean);
            if (segments.length > 1) {
              segments.pop();
              return { path: segments.join('/'), select: false };
            }
            return { path: relativePath, select: false };
          }
          return { path: relativePath, select: true };
        }

        async function revealAsset(relativePath, mode = 'file') {
          const payload = buildRevealPayload(relativePath, mode);
          if (!payload) {
            return;
          }
          try {
            await request('/api/assets/reveal', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            const message =
              mode === 'folder'
                ? 'Opening folder in your file manager.'
                : 'Opening asset location in your file manager.';
            showStatus(message, 'info');
          } catch (error) {
            showStatus(error.message, 'error');
          }
        }

        dom.viewButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const view = button.dataset.view;
            if (!view) {
              return;
            }
            setActiveView(view);
            if (view === 'create') {
              dom.createModule.focus();
            } else if (view === 'details' && state.editMode && state.selectedLectureId) {
              dom.editName.focus();
            }
          });
        });

        if (dom.editToggle) {
          dom.editToggle.addEventListener('click', () => {
            state.editMode = !state.editMode;
            updateEditModeUI();
            if (state.editMode && state.selectedLectureId) {
              setActiveView('details');
              dom.editName.focus();
            }
          });
        }

        dom.search.addEventListener('input', (event) => {
          state.query = event.target.value;
          renderCurriculum();
        });

        dom.editForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!state.editMode) {
            showStatus('Enable edit mode to update lecture details.', 'info');
            return;
          }
          if (!state.selectedLectureId) {
            return;
          }
          const payload = {
            name: dom.editName.value.trim(),
            description: dom.editDescription.value.trim(),
          };
          const moduleValue = dom.editModule.value;
          if (moduleValue) {
            payload.module_id = Number(moduleValue);
          }
          if (!payload.name) {
            showStatus('Lecture title is required.', 'error');
            return;
          }
          try {
            await request(`/api/lectures/${state.selectedLectureId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            showStatus('Lecture updated.', 'success');
            await refreshData();
            await selectLecture(state.selectedLectureId);
          } catch (error) {
            showStatus(error.message, 'error');
          }
        });

        dom.deleteButton.addEventListener('click', async () => {
          if (!state.selectedLectureId || !state.editMode) {
            return;
          }
          const confirmed = window.confirm('Delete this lecture and all linked assets?');
          if (!confirmed) {
            return;
          }
          const secondCheck = window.confirm(
            'This action cannot be undone. Do you want to permanently remove it?',
          );
          if (!secondCheck) {
            return;
          }
          try {
            await request(`/api/lectures/${state.selectedLectureId}`, { method: 'DELETE' });
            showStatus('Lecture removed.', 'success');
            state.selectedLectureId = null;
            clearDetailPanel();
            await refreshData();
          } catch (error) {
            showStatus(error.message, 'error');
          }
        });

        dom.createForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const moduleId = Number(dom.createModule.value);
          const name = dom.createName.value.trim();
          const description = dom.createDescription.value.trim();
          if (!moduleId || !name) {
            showStatus('Select a module and enter a title.', 'error');
            return;
          }
          try {
            const payload = await request('/api/lectures', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ module_id: moduleId, name, description }),
            });
            dom.createForm.reset();
            showStatus('Lecture created.', 'success');
            await refreshData();
            const newLectureId = payload?.lecture?.id;
            if (newLectureId) {
              await selectLecture(newLectureId);
            }
          } catch (error) {
            showStatus(error.message, 'error');
          }
        });

        dom.transcribeButton.addEventListener('click', async () => {
          if (!state.selectedLectureId) {
            return;
          }
          dom.transcribeButton.disabled = true;
          try {
            await request(`/api/lectures/${state.selectedLectureId}/transcribe`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ model: dom.transcribeModel.value }),
            });
            showStatus('Transcription completed.', 'success');
            await refreshData();
            await selectLecture(state.selectedLectureId);
          } catch (error) {
            showStatus(error.message, 'error');
          } finally {
            dom.transcribeButton.disabled = false;
          }
        });

        if (dom.settingsForm) {
          dom.settingsForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const themeValue = dom.settingsTheme.value || 'system';
            const modelValue = dom.settingsWhisperModel.value.trim() || 'base';
            const computeValue = dom.settingsWhisperCompute.value.trim() || 'int8';
            const beamValue = Math.max(
              1,
              Math.min(10, Number(dom.settingsWhisperBeam.value) || 5),
            );
            const dpiValue = Math.max(
              72,
              Math.min(600, Number(dom.settingsSlideDpi.value) || 200),
            );

            try {
              const response = await request('/api/settings', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  theme: themeValue,
                  whisper_model: modelValue,
                  whisper_compute_type: computeValue,
                  whisper_beam_size: beamValue,
                  slide_dpi: dpiValue,
                }),
              });
              state.settings = response?.settings ?? {
                theme: themeValue,
                whisper_model: modelValue,
                whisper_compute_type: computeValue,
                whisper_beam_size: beamValue,
                slide_dpi: dpiValue,
              };
              ensureTranscribeOption(modelValue);
              dom.transcribeModel.value = modelValue;
              applyTheme(themeValue);
              showStatus('Settings saved.', 'success');
            } catch (error) {
              showStatus(error.message, 'error');
            }
          });
        }
        setActiveView(state.activeView);
        updateEditModeUI();
        clearDetailPanel();
        applyTheme('system');
        loadSettings();
        refreshData();
      })();
    </script>
  </body>
</html>
